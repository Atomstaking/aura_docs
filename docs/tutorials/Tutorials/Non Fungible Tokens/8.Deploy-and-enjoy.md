# Deploy our contract and play with it

## 1. Generate and test the schema

1. Define the schema in `src/bin/schema.rs`

We should generate JSON Schemas that serve as a guide for anyone trying to use the contract. 

```rust
use std::env::current_dir;
use std::fs::create_dir_all;

use cosmwasm_schema::{export_schema, remove_schemas, schema_for};

use aura_nft::msg::{ConfigResponse, ExecuteMsg, InstantiateMsg, QueryMsg};

fn main() {
    let mut out_dir = current_dir().unwrap();
    out_dir.push("schema");
    create_dir_all(&out_dir).unwrap();
    remove_schemas(&out_dir).unwrap();

    export_schema(&schema_for!(InstantiateMsg), &out_dir);
    export_schema(&schema_for!(ExecuteMsg), &out_dir);
    export_schema(&schema_for!(QueryMsg), &out_dir);
    export_schema(&schema_for!(ExecuteMsg), &out_dir);
    export_schema(&schema_for!(ConfigResponse), &out_dir);
}
```
2. Generate the new schema.

```sh Terminal
cd aura_nft
cargo schema
```

The output will be look like this:
```
â”œâ”€â”€ schema/ 
â”‚   â”œâ”€â”€ config_response.json
â”‚   â”œâ”€â”€ execute_msg.json
â”‚   â”œâ”€â”€ instantiate_msg.json 
â”‚   â”œâ”€â”€ query_msg.json
```

## 2. Build and deploy contract

Build and deploy contract 

Before your contract can be used, it has to be compiled, and then stored on chain.

1. Store `cw721_base` contract

As i said before, we use `cw721_base` contract to create instances then interact with it to generate NFT. You can clone `cw721_base` at [link](https://github.com/CosmWasm/cw-nfts/tree/main/contracts/cw721-base). Because this repository is not default of beaker, the smart-way to store `cw721_base` contract is use cli. Firstly, you change current workspace into `contract/cw721-base`, then compile contract:

```bash
RUSTFLAGS='-C link-arg=-s' cargo wasm
```

When successful, will be have file `cw721_base.wasm` in folder `target/wasm32-unknown-unknown/release`. We will deploy this into mainnet.

```bash
NODE="https://rpc.serenity.aura.network:443"
ACCOUNT="aloha"
CHAINID="serenity-testnet-001"
CONTRACT_DIR="target/wasm32-unknown-unknown/release/cw721_base.wasm"
SLEEP_TIME="15s"

RES=$(aurad tx wasm store "$CONTRACT_DIR" --from "$ACCOUNT" -y --output json --chain-id "$CHAINID" --node "$NODE" --gas 35000000 --fees 35000uaura -y --output json)
echo $RES

if [ "$(echo $RES | jq -r .raw_log)" == "[]" ]; then
    # exit
    echo "ERROR = $(echo $RES | jq .raw_log)"
    exit 1
else
    echo "STORE SUCCESS"
fi

TXHASH=$(echo $RES | jq -r .txhash)

echo $TXHASH

# sleep for chain to update
sleep "$SLEEP_TIME"

RAW_LOG=$(aurad query tx "$TXHASH" --chain-id "$CHAINID" --node "$NODE" -o json | jq -r .raw_log)

echo $RAW_LOG

CODE_ID=$(echo $RAW_LOG | jq -r .[0].events[1].attributes[0].value)

echo $CODE_ID
```

For this, I have uploaded the code of cw721_base (version 0.15.0) to Aura testnet with code_id of 230. You can use this code_id or customize your own cw721_base by yourself.

2. Deploy contract

```bash
beaker wasm deploy cw721-factory --raw '{"cw20_address":"aura1yj9f4ktaja603dvrjq4f526y5ssscslhd85k3cx0a7z7z5pkp64qxgh3ql", "max_tokens":100, "name":"Hola Amigo", "owner":"aura10dyct5559d7c767mkmjmzh022fq52ara95vdje", "symbol":"ANT", "token_code_id": 230, "token_uri": "https://res.cloudinary.com/stargaze/image/upload/w_700/qg9ch3mcfp2bbm09uw7q.mp4", "unit_price": "13"}' --signer-account aloha --network euphoria --gas 35000ueaura --gas-limit 8000000 --label Aura_NFT
```

After running the above bash command, if successful, your terminal will print something similar to this:

```
  Code stored successfully!! ðŸŽ‰
    +
    â”œâ”€â”€ code_id: 236
    â””â”€â”€ instantiate_permission: â€“


  Contract instantiated successfully!! ðŸŽ‰ 
    +
    â”œâ”€â”€ label: Aura_NFT
    â”œâ”€â”€ contract_address: aura1antu4zlsdvt7d6p8gscw5le5z96ngzg6lfr7fdeqyxqfa5yvhlssyu9z0z
    â”œâ”€â”€ code_id: 236
    â”œâ”€â”€ creator: aura10dyct5559d7c767mkmjmzh022fq52ara95vdje
    â””â”€â”€ admin: -
 ```

After successful deployment, you can see result has been written into `.beaker`. 

## 3. Now, let's play with it

### 1. Mint an NFT

Now let's begin minting NFT. All of things we need to do is transfer cw20 token to cw721 contract address.

```bash
#!/bin/bash
beaker wasm execute cw20-token --raw '{"send": {"contract":"aura1antu4zlsdvt7d6p8gscw5le5z96ngzg6lfr7fdeqyxqfa5yvhlssyu9z0z", "amount":"13", "msg": ""}}' --signer-account signer --network euphoria --gas 35000ueaura --gas-limit 8000000
```

After running the above bash command, if successful, your terminal will print something similar to this:

```

```

### 2. Query NFT info

Create `scripts/query_info_nft.sh` and paste the following.

```bash
#!/bin/bash

NODE="https://rpc.euphoria.aura.network:443"
ACCOUNT="my-first-wallet"
CHAINID="euphoria-1"
CONTRACT_DIR="artifacts/aura_nft.wasm"
SLEEP_TIME="15s"
CW721_ADDRESS="aura1z6x7ch6qmseyzyj0ns3k09y00cys02p23pc8ehhuxnjrj8martesjud6sf"

ALL_NFTS_QUERY="{\"all_tokens\": {}}"
echo $(aurad query wasm contract-state smart "$CW721_ADDRESS" "$ALL_NFTS_QUERY" --node "$NODE" --output json)


# CHANGE TOKEN_ID HERE
# $# is to check number of arguments
TOKEN_ID="$1"

SINGLE_NFT_QUERY="{\"all_nft_info\": {\"token_id\": \"$TOKEN_ID\"}}"
echo $(aurad query wasm contract-state smart "$CW721_ADDRESS" "$SINGLE_NFT_QUERY" --node "$NODE" --output json | jq --color-output -r )
```

Open your terminal:

 ```sh Terminal
 bash scripts/query_info_nft.sh [TOKEN_ID]
 ```

Example:

 ```sh Terminal
 bash scripts/query_info_nft.sh 0
 ```

After running the above bash command, if successful, your terminal will print something similar to this:

```
{"data":{"tokens":["0"]}}
{ "data": { "access": { "owner": "aura1t0wc2swe77hah62lul0zwlpfje842w4csrcq4t", "approvals": [] }, "info": { "token_uri": "https://res.cloudinary.com/stargaze/image/upload/w_700/qg9ch3mcfp2bbm09uw7q.mp4", "extension": null } } }
```

### 3. Query Config state of our contract

Create `scripts/get_config.sh` and paste the following.

```bash
#!/bin/bash

NODE="https://rpc.euphoria.aura.network:443"
ACCOUNT="my-first-wallet"
CHAINID="euphoria-1"
CONTRACT_DIR="artifacts/aura_nft.wasm"
SLEEP_TIME="15s"

CW721_MINTER_CONTRACT_ADDR="aura14gp9d4euw4kehxarar7r3l903nqef6qz8mgw5w6cewtjantz7m6q9tgpv4"

CONFIG_QUERY="{\"get_config\": {}}"
CONFIG=$(aurad query wasm contract-state smart "$CW721_MINTER_CONTRACT_ADDR" "$CONFIG_QUERY" --node "$NODE" --output json)

echo $CONFIG
```

Open your terminal:

 ```sh Terminal
 bash scripts/get_config.sh
 ```

After running the above bash command, if successful, your terminal will print something similar to this:

```
{"data":{"owner":"aura1t0wc2swe77hah62lul0zwlpfje842w4csrcq4t","cw20_address":"aura1e30u7tkfmq9fueyuwtmnep3wl8rrdcj2gusvylsruzpn7cfaavtqhx76sz","cw721_address":"aura1z6x7ch6qmseyzyj0ns3k09y00cys02p23pc8ehhuxnjrj8martesjud6sf","max_tokens":100,"unit_price":"1000","name":"Aura NFT Test Token","symbol":"ANT","token_uri":"https://res.cloudinary.com/stargaze/image/upload/w_700/qg9ch3mcfp2bbm09uw7q.mp4","extension":null,"unused_token_id":1}}
```


## Thank you very much!

Well, we've reached the end of the amazing CosmWasm tutorial series. We'd like to thank you for following our story so far. If this tutorial has helped even just one person it makes it so worth it.